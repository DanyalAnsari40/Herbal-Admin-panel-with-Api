<% orders.forEach((order, index) => { 
  const isMyOrder = order.handledBy && order.handledBy._id?.toString() === user.id;
  const rowColor = order.isInProgress
    ? (isMyOrder ? 'bg-yellow-50' : 'bg-red-100')
    : (index % 2 === 0 ? 'bg-white' : 'bg-gray-50');
%>
<tr class="border-b border-gray-100 transition-colors duration-200 <%= rowColor %>">
  <td class="py-4 px-6 font-semibold text-gray-800"><%= order.name %></td>
  <td class="py-4 px-6 font-semibold text-gray-800"><%= order.phone %></td>
  <td class="py-4 px-6 text-sm text-gray-500"><%= new Date(order.createdAt).toLocaleDateString() %></td>

  <!-- Review -->
  <td class="py-4 px-6 text-sm">
    <% if (isMyOrder) { %>
      <div x-data="{ edit: false }" class="flex justify-center items-center space-x-2">
        <template x-if="!edit">
          <div class="flex items-center space-x-2">
            <i class="fas fa-quote-left text-yellow-500"></i>
            <span><%= order.review || "No review yet" %></span>
            <button type="button" @click="edit = true" class="text-green-600 hover:text-green-800 ml-2">
              <i class="fas fa-pen"></i>
            </button>
          </div>
        </template>
        <template x-if="edit">
          <form action="/admin/orders/add-review" method="POST" class="flex items-center space-x-2">
            <input type="hidden" name="orderId" value="<%= order._id %>">
            <input type="text" name="review" value="<%= order.review || '' %>" class="border px-2 py-1 rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-300">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">Save</button>
            <button type="button" @click="edit = false" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          </form>
        </template>
      </div>
    <% } else { %>
      <div class="flex items-center space-x-2 text-gray-500 relative group">
        <i class="fas fa-quote-left text-yellow-500"></i>
        <span><%= order.review || "No review yet" %></span>
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-200">
          <i class="fas fa-ban text-red-400 text-xl" title="You must handle this order first"></i>
        </div>
      </div>
    <% } %>
  </td>

  <!-- Handled By -->
  <td class="py-4 px-6"><%= order.handledBy ? (order.handledBy.displayName || order.handledBy.email) : 'Not assigned' %></td>

  <!-- Call Status -->
  <td class="py-4 px-6 text-sm">
    <% if (isMyOrder) { %>
      <form action="/admin/orders/update-call-status" method="POST" class="flex items-center space-x-4 flex-wrap">
        <input type="hidden" name="orderId" value="<%= order._id %>">
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Answered" <%= order.callStatus==='Answered' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-green-600">
          <span class="text-green-700 font-semibold">Answered</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Declined" <%= order.callStatus==='Declined' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-red-600">
          <span class="text-red-700 font-semibold">Declined</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Pending" <%= order.callStatus==='Pending' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-yellow-500">
          <span class="text-yellow-600 font-semibold">Pending</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Cancelled" <%= order.callStatus==='Cancelled' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-gray-600">
          <span class="text-gray-700 font-semibold">Cancelled</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Not-Attend" <%= order.callStatus==='Not-Attend' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-blue-600">
          <span class="text-blue-700 font-semibold">Not-Attend</span>
        </label>
        <label class="flex items-center space-x-1 cursor-pointer">
          <input type="radio" name="callStatus" value="Power Off" <%= order.callStatus==='Power Off' ? 'checked' : '' %> onchange="this.form.submit()" class="accent-purple-600">
          <span class="text-purple-700 font-semibold">Power Off</span>
        </label>
      </form>
    <% } else { %>
      <div class="flex items-center space-x-3 text-gray-400 relative group flex-wrap">
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Answered' ? 'checked' : '' %>><span>Answered</span></label>
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Declined' ? 'checked' : '' %>><span>Declined</span></label>
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Pending' ? 'checked' : '' %>><span>Pending</span></label>
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Cancelled' ? 'checked' : '' %>><span>Cancelled</span></label>
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Not-Attend' ? 'checked' : '' %>><span>Not-Attend</span></label>
        <label class="flex items-center space-x-1 cursor-not-allowed"><input type="radio" disabled <%= order.callStatus==='Power Off' ? 'checked' : '' %>><span>Power Off</span></label>
        <i class="fas fa-ban text-red-400 opacity-0 group-hover:opacity-100 transition duration-200" title="You must handle this order first"></i>
      </div>
    <% } %>
  </td>

  <!-- Handle -->
  <td class="py-4 px-6">
    <form action="/admin/orders/toggle-lock/<%= order._id %>" method="POST">
      <% if (!order.isInProgress) { %>
        <input type="hidden" name="nextHandle" value="Handled">
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm shadow">Handle</button>
      <% } else if (isMyOrder) { %>
        <input type="hidden" name="nextHandle" value="Unhandled">
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm shadow">Release</button>
      <% } else { %>
        <span class="text-red-500"><i class="fas fa-lock mr-1"></i>In Progress</span>
      <% } %>
    </form>
  </td>
</tr>
<% }) %>
